# WebAssembly build workflow for GFX graphics library
name: Web Build

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'

    - name: Configure CMake
      run: |
        emcmake cmake -B build_web \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_WEBGPU_BACKEND=ON \
          -DBUILD_VULKAN_BACKEND=OFF \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build_web

    - name: Upload web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-examples
        path: |
          build_web/examples/web/cube_example_web.html
          build_web/examples/web/cube_example_web.js
          build_web/examples/web/cube_example_web.wasm
          build_web/examples/web/cube_example_web.data
          build_web/examples/web/cube_example_cpp_web.html
          build_web/examples/web/cube_example_cpp_web.js
          build_web/examples/web/cube_example_cpp_web.wasm
          build_web/examples/web/cube_example_cpp_web.data
          build_web/examples/web/compute_example_web.html
          build_web/examples/web/compute_example_web.js
          build_web/examples/web/compute_example_web.wasm
          build_web/examples/web/compute_example_web.data
          build_web/examples/web/compute_example_cpp_web.html
          build_web/examples/web/compute_example_cpp_web.js
          build_web/examples/web/compute_example_cpp_web.wasm
          build_web/examples/web/compute_example_cpp_web.data
        retention-days: 7

    - name: Deploy Web
      run: |
        mkdir -p public
        cp -r build_web/examples/web/* public/
        # Copy the clean template from your repo to the public folder
        cp web/index.html public/index.html || true

    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
